<!DOCTYPE html>

<html>
<head>
  <title>upward.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>upward.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> {keys, assign, defineProperty} = <span class="hljs-built_in">Object</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h3 id="configuration">Configuration</h3>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Control upward configuration with <code>LOGGING</code> and <code>DEBUG</code> flags.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> upwardConfig = {
  LOGGING: <span class="hljs-literal">true</span>,
  DEBUG: <span class="hljs-literal">true</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Keep a counter which identifies upwardables for debugging purposes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> id = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Set configuration options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">configureUpwardable</span><span class="hljs-params">(opts)</span> </span>{
  assign (upwardConfig, opts);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">objectToString</span><span class="hljs-params">(o)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">'{'</span> + keys(o).map(k =&gt; `${k}: ${o[k]}`).join(<span class="hljs-string">', '</span>) + <span class="hljs-string">'}'</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span><span class="hljs-params">(...args)</span> </span>{
  <span class="hljs-keyword">if</span> (upwardConfig.LOGGING) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'UPWARDIFY:\t'</span>, ...args);
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Generic version of <code>valueOf</code> which works for anything.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">valueOf</span><span class="hljs-params">(v)</span> </span>{
    <span class="hljs-keyword">return</span> v == <span class="hljs-literal">null</span> ? v : v.valueOf();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Analog of <code>Array#map</code> for objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mapObject</span><span class="hljs-params">(o, fn, ctxt)</span> </span>{
  <span class="hljs-keyword">return</span> keys(o).reduce((result, k) =&gt; result[k] = fn.call(ctxt, o[k]), result);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Return an object all of the values of which are evaluated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">valueObject</span><span class="hljs-params">(o)</span> </span>{
  <span class="hljs-keyword">return</span> mapObject(o, valueOf);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">objectValues</span><span class="hljs-params">(o)</span> </span>{
  <span class="hljs-keyword">return</span> keys(o).map(k =&gt; o[k]);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Transform a function so that it always returns <code>this</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">chainify</span><span class="hljs-params">(fn)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(...args)</span> </span>{ fn.call(<span class="hljs-keyword">this</span>, ...args); <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>; };
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeUpwardableProperty</span><span class="hljs-params">(o, p)</span> </span>{
  <span class="hljs-keyword">return</span> Upwardable(o[p], {o, p}).defineAsProperty(o, p);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Upwardable</span><span class="hljs-params">(v, options = {}, upwards = [])</span> </span>{
  <span class="hljs-built_in">console</span>.assert(<span class="hljs-string">"Cannot make upwardable out of upwardable"</span>, !isUpwardable(v));

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> `upwardable on ${objectToString(options)}`; }

  <span class="hljs-keyword">var</span> accessor = {
    get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>   </span>{ <span class="hljs-keyword">return</span> upwardable; },
    set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(nv)</span> </span>{
      upwards.forEach(fn =&gt; fn(valueOf(nv), valueOf(v), <span class="hljs-keyword">this</span>, options));
      v = nv; 
    },
    enumerable: <span class="hljs-literal">true</span>
  };

  <span class="hljs-keyword">var</span> upwardable = {
    valueOf()         { <span class="hljs-keyword">return</span> valueOf(v); },
    upward(fn)        { upwards.push(fn); },
    define(o, p)      { <span class="hljs-keyword">return</span> defineProperty(o, p, accessor); },
  };

  upwardable.define(upwardable, <span class="hljs-string">'val'</span>);
  
  <span class="hljs-keyword">if</span> (upwardConfig.DEBUG) {
    assign(upwardable, {id, toString});
    id++;
  }

  <span class="hljs-keyword">return</span> upwardable;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Check if something is upwardable, by looking for its <code>upward</code> property.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isUpwardable</span><span class="hljs-params">(u)</span> </span>{
  <span class="hljs-keyword">return</span> u &amp;&amp; <span class="hljs-keyword">typeof</span> u === <span class="hljs-string">'object'</span> &amp;&amp; u.upward;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Make something upwardable if it isn’t already.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">castUpwardable</span><span class="hljs-params">(u)</span> </span>{
  <span class="hljs-keyword">return</span> isUpwardable(u) ? u : Upwardable(u);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Safely set an upward relationship, or not..</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upward</span><span class="hljs-params">(o, fn)</span> </span>{
  <span class="hljs-keyword">return</span> isUpwardable(o) &amp;&amp; o.upward(fn);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Create an upwardable whose value is given by a function.
When any of the specified dependencies change, the value is recomputed,
triggering the upward behavior.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">computedUpwardable</span><span class="hljs-params">(fn, deps)</span> </span>{
  <span class="hljs-keyword">var</span> result = Upwardable();
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set</span><span class="hljs-params">()</span> </span>{ result.val = fn(); }
  deps.forEach(v =&gt; upward(v, set));
  set();
  <span class="hljs-keyword">return</span> result;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Transform a function to make it upward-aware.
The first time, it calls the passed-in function, maintaining context.
When things change, it calls an alternative function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upwardify</span><span class="hljs-params">(fn, changefn = fn)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v)</span> </span>{
    upward(v, changefn.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">return</span> fn.call(<span class="hljs-keyword">this</span>, valueOf(v));
  };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><code>upwardifyWithObjectParam</code> creates a function which takes a hash as its parameter.
On the first call, the underlying function is called with the cooked hash.
When properties in the hash change, a <code>changefn</code> is called with the key and new value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upwardifyWithObjectParam</span><span class="hljs-params">(fn, changefn)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span> </span>{
    upwardifyProperties(o);
    keys(o).forEach(k =&gt; upward(o[k], nv =&gt; changefn(k, nv)));
    <span class="hljs-keyword">return</span> fn.call(<span class="hljs-keyword">this</span>, valueOfObject(o));
  };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>A common case for functions taking a hash as argument is to want to merge (assign)
the property/value pairs into an underlying hash, 
which should then be updated when the hash changes.
<code>upwardifyAssign</code> turns a hash into a function which modifies it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upwardifiedAssign</span><span class="hljs-params">(o)</span> </span>{
  <span class="hljs-keyword">return</span> upwardifyWithObjectParam(
    oo =&gt; assign(o, oo),
    (p, v) =&gt; o[p] = v
  );
}</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><code>upwardifyProperty</code> modifies a single property on an object for upwardability.
This is mainly used from ‘upwardifyProperties` below.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upwardifyProperty</span><span class="hljs-params">(o, p)</span> </span>{
  castUpwardable(o[p]).define(o, p);
  <span class="hljs-keyword">return</span> o;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><code>upwardifyProperties</code> modifies all properties in an object, in place, for upwardability.
A non-enumerable <code>upwardified</code> property is added to the object.
Note this is <em>not</em> the same as making the object itself upwardable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upwardifyProperties</span><span class="hljs-params">(o)</span> </span>{
  <span class="hljs-keyword">if</span> (!o.upwardified) {
    keys(o).forEach(k =&gt; upwardifyProperty(o, k));
    setProperty(o, <span class="hljs-string">'upwardified'</span>, { value: <span class="hljs-literal">true</span> });
  }
  <span class="hljs-keyword">return</span> o;
}

export {
  Upwardable,
  isUpwardable,
  upward,
  computedUpwardable,
  chainify,
  upwardify,
  upwardifyProperties,
  configureUpwardable
};
L</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
